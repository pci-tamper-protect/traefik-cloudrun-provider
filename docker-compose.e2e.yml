# docker-compose.e2e.yml - E2E testing with Traefik, Frontend, and Backend
# Simulates Cloud Run architecture: public gateway, private services
version: '3.8'

services:
  # Traefik - Public Gateway (like Cloud Run's public Traefik service)
  # NOTE: e-skimming-labs uses Traefik v3.0 in production
  # This v2.10 is for E2E testing only (v2.10 doesn't support local plugins)
  traefik:
    image: traefik:v2.10
    command:
      # API and Dashboard
      - --api.dashboard=true
      - --api.insecure=true

      # Logging
      - --log.level=DEBUG
      - --accesslog=true

      # Docker provider (instead of Cloud Run provider for local testing)
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=traefik-network

      # Entrypoints
      - --entryPoints.web.address=:80
      - --entryPoints.websecure.address=:443
    ports:
      - "${TRAEFIK_WEB_PORT:-8090}:80"     # Web traffic (local:container)
      - "${TRAEFIK_API_PORT:-8091}:8080"   # Dashboard/API (local:container)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.dashboard.service=api@internal"

  # Backend - Private service (only accessible through Traefik)
  # No ports exposed - service is private/internal only
  backend:
    build:
      context: ./tests/e2e/backend
      dockerfile: Dockerfile
    environment:
      - PORT=8080
    networks:
      - traefik-network
    # No ports exposed - private service
    labels:
      # Enable Traefik
      - "traefik.enable=true"

      # HTTP Router for API
      - "traefik.http.routers.backend.rule=Host(`api.localhost`)"
      - "traefik.http.routers.backend.entrypoints=web"
      - "traefik.http.routers.backend.service=backend"

      # Service
      - "traefik.http.services.backend.loadbalancer.server.port=8080"

      # Middlewares (simulate Cloud Run auth)
      - "traefik.http.routers.backend.middlewares=backend-headers"
      - "traefik.http.middlewares.backend-headers.headers.customrequestheaders.X-Forwarded-By=traefik"

  # Frontend - Private service (only accessible through Traefik)
  # No ports exposed - service is private/internal only
  frontend:
    build:
      context: ./tests/e2e/frontend
      dockerfile: Dockerfile
    environment:
      - PORT=8080
      # Frontend calls backend via Traefik gateway (simulating Cloud Run service-to-service)
      # Using Traefik's internal network address
      - BACKEND_URL=http://traefik:80
      - BACKEND_HOST=api.localhost
    networks:
      - traefik-network
    depends_on:
      - backend
      - traefik
    # No ports exposed - private service
    labels:
      # Enable Traefik
      - "traefik.enable=true"

      # HTTP Router
      - "traefik.http.routers.frontend.rule=Host(`app.localhost`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.service=frontend"

      # Service
      - "traefik.http.services.frontend.loadbalancer.server.port=8080"

      # Middlewares
      - "traefik.http.routers.frontend.middlewares=frontend-headers"
      - "traefik.http.middlewares.frontend-headers.headers.customrequestheaders.X-Forwarded-By=traefik"

networks:
  traefik-network:
    driver: bridge
