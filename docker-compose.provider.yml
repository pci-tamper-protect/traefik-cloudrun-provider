# docker-compose.test.yml - E2E testing with Traefik
version: '3.8'

services:
  # Provider service - generates routes.yml
  provider:
    build:
      context: .
      dockerfile: Dockerfile.provider
    volumes:
      - ./test-output:/output
      # Mount ADC credentials for local testing
      - ${HOME}/.config/gcloud:/home/cloudrunner/.config/gcloud:ro
    environment:
      - CLOUDRUN_PROVIDER_DEV_MODE=true
      - LOG_LEVEL=DEBUG
      - LOG_FORMAT=text
      - ENVIRONMENT=stg
      - LABS_PROJECT_ID=${LABS_PROJECT_ID:-my-project-stg}
      - HOME_PROJECT_ID=${HOME_PROJECT_ID:-my-home-stg}
      - REGION=${REGION:-us-central1}
    command: ["/output/routes.yml"]
    networks:
      - traefik-test

  # Traefik service - uses generated routes
  traefik:
    image: traefik:v2.10
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --log.level=DEBUG
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true
      - --entryPoints.web.address=:80
      - --entryPoints.websecure.address=:443
    ports:
      - "${TRAEFIK_WEB_PORT:-8090}:80"           # Web entrypoint (local:container)
      - "${TRAEFIK_API_PORT:-8091}:8080"         # Dashboard/API (local:container)
      - "${TRAEFIK_WEBSECURE_PORT:-8493}:443"    # Websecure entrypoint (local:container)
    volumes:
      - ./test-output:/etc/traefik/dynamic:ro
    networks:
      - traefik-test
    depends_on:
      - provider

networks:
  traefik-test:
    driver: bridge
